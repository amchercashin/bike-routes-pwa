"use strict";(self.webpackChunkbike_routes_pwa=self.webpackChunkbike_routes_pwa||[]).push([[237],{54:(e,t,n)=>{n.r(t),n.d(t,{default:()=>v});var o=n(43),r=n(216),i=n(475),s=n(896),a=n(419),c=n(23),l=n(30),d=n(36),u=n(318),p=n(228),g=n.n(p),h=(n(433),n(579));const f=new(g().Icon)({iconUrl:"https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",shadowUrl:"https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});function m(e){let{bounds:t}=e;const n=(0,s.ko)();return o.useEffect((()=>{t&&n.fitBounds(t)}),[n,t]),null}const x=function(e){let{route:t,position:n,heading:r,isOffline:i}=e;const{bounds:s,routeLines:p,routePoints:x}=(0,o.useMemo)((()=>{if(!t||!t.lines&&!t.points)return{bounds:null,routeLines:[],routePoints:[]};const e=[...t.lines?t.lines.flat():[],...t.points?t.points.map((e=>e.coordinates)):[]];let o=g().latLngBounds(e.map((e=>{let[t,n]=e;return[n,t]})));return n&&o.extend([n.latitude,n.longitude]),{bounds:o,routeLines:t.lines||[],routePoints:t.points||[]}}),[t,n]);if(!s)return null;const w=g().divIcon({className:"location-arrow",html:'<div style="transform: rotate('.concat(r||0,'deg); color: red; font-size: 16px;">\u27a4</div>'),iconSize:[24,24],iconAnchor:[12,12]}),j=s.getCenter();return(0,h.jsxs)("div",{style:{position:"relative",height:"400px",width:"100%"},children:[(0,h.jsxs)(a.W,{center:j,zoom:12,style:{height:"100%",width:"100%"},children:[(0,h.jsx)(c.e,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'\xa9 <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'}),p.map(((e,t)=>(0,h.jsx)(l.R,{positions:e.map((e=>{let[t,n]=e;return[n,t]})),color:"blue"},"line-".concat(t)))),x.map(((e,t)=>(0,h.jsx)(d.p,{position:[e.coordinates[1],e.coordinates[0]],icon:f,children:(0,h.jsxs)(u.z,{children:[(0,h.jsx)("strong",{children:e.name}),e.description&&(0,h.jsx)("p",{children:e.description})]})},"point-".concat(t)))),n&&(0,h.jsx)(d.p,{position:[n.latitude,n.longitude],icon:w,children:(0,h.jsx)(u.z,{children:"\u0412\u044b \u0437\u0434\u0435\u0441\u044c"})}),(0,h.jsx)(m,{bounds:s})]}),(0,h.jsx)("div",{style:{position:"absolute",bottom:0,right:220,backgroundColor:"white",padding:"0 5px",fontSize:"12px",zIndex:1e3},children:"\ud83c\uddf7\ud83c\uddfa"}),i&&(0,h.jsx)("div",{style:{position:"absolute",top:10,left:10,backgroundColor:"rgba(255, 255, 255, 0.8)",padding:"5px 10px",borderRadius:"5px",zIndex:1e3},children:"\u041e\u0444\u043b\u0430\u0439\u043d-\u0440\u0435\u0436\u0438\u043c: \u043a\u0430\u0440\u0442\u0430 \u043c\u043e\u0436\u0435\u0442 \u0431\u044b\u0442\u044c \u043d\u0435\u043f\u043e\u043b\u043d\u043e\u0439"})]})};var w=n(247);const j=function(){const{position:e,heading:t,error:n}=(0,w.V)();return n?(0,h.jsxs)("div",{children:["\u041e\u0448\u0438\u0431\u043a\u0430 \u0433\u0435\u043e\u043b\u043e\u043a\u0430\u0446\u0438\u0438: ",n]}):e?(0,h.jsxs)("div",{children:[(0,h.jsx)("h2",{children:"\u0412\u0430\u0448\u0435 \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u0435:"}),(0,h.jsxs)("p",{children:["\u0428\u0438\u0440\u043e\u0442\u0430: ",e.latitude.toFixed(6)]}),(0,h.jsxs)("p",{children:["\u0414\u043e\u043b\u0433\u043e\u0442\u0430: ",e.longitude.toFixed(6)]}),null!==t&&(0,h.jsxs)("p",{children:["\u041d\u0430\u043f\u0440\u0430\u0432\u043b\u0435\u043d\u0438\u0435: ",t.toFixed(2),"\xb0"]})]}):(0,h.jsx)("div",{children:"\u041e\u043f\u0440\u0435\u0434\u0435\u043b\u0435\u043d\u0438\u0435 \u043c\u0435\u0441\u0442\u043e\u043f\u043e\u043b\u043e\u0436\u0435\u043d\u0438\u044f..."})};var y=n(337),b=n(677);const v=function(){const{id:e}=(0,r.g)(),[t,n]=(0,o.useState)(null),{position:s,heading:a}=(0,w.V)(),[c,l]=(0,o.useState)(null),[d,u]=(0,o.useState)(!0),[p,g]=(0,o.useState)(!navigator.onLine);if((0,o.useEffect)((()=>{const e=()=>g(!1),t=()=>g(!0);return window.addEventListener("online",e),window.addEventListener("offline",t),()=>{window.removeEventListener("online",e),window.removeEventListener("offline",t)}}),[]),(0,o.useEffect)((()=>{!async function(){try{u(!0);let t=await(0,y.aM)(e);if(!t||!p){const n=await fetch("".concat("/bike-routes-pwa","/data/routes/index.json")),o=(await n.json()).find((t=>t.id===e));if(!o)throw new Error("Route info not found");if(await(0,y.wp)(e).catch((()=>null))!==o.version){const n=await fetch("".concat("/bike-routes-pwa","/data/routes/").concat(e,".kml")),r=await n.blob();t=function(e){console.log("Extracting route from GeoJSON:",JSON.stringify(e,null,2));const t={name:"",description:"",lines:[],points:[]};if("FeatureCollection"===e.type){e.features.forEach((e=>{"Point"===e.geometry.type?t.points.push({name:e.properties.name||"",description:e.properties.description||"",coordinates:e.geometry.coordinates}):"LineString"===e.geometry.type?t.lines.push(e.geometry.coordinates):"MultiGeometry"!==e.geometry.type&&"GeometryCollection"!==e.geometry.type||e.geometry.geometries.forEach((e=>{"LineString"===e.type&&t.lines.push(e.coordinates)}))}));const n=e.features.find((e=>e.properties.name&&e.properties.description));n&&(t.name=n.properties.name,t.description=n.properties.description)}return console.log("Extracted route data:",t),t}(await async function(e){const t=await e.text();console.log("Raw KML content:",t.substring(0,500)+"...");const n=(new DOMParser).parseFromString(t,"text/xml");if(n.getElementsByTagName("parsererror").length>0)throw console.error("XML parsing error:",n.getElementsByTagName("parsererror")[0].textContent),new Error("Failed to parse KML file");const o=(0,b.bW)(n);return console.log("Parsed GeoJSON:",JSON.stringify(o,null,2)),o}(new File([r],"".concat(e,".kml")))),t.id=e,t.version=o.version,await(0,y.Fq)(t).catch(console.error)}else t||(t=await(0,y.aM)(e))}n(t)}catch(c){console.error("Error loading route ".concat(e,":"),c),l("\u041e\u0448\u0438\u0431\u043a\u0430 \u0437\u0430\u0433\u0440\u0443\u0437\u043a\u0438 \u043c\u0430\u0440\u0448\u0440\u0443\u0442\u0430: ".concat(c.message))}finally{u(!1)}}()}),[e,p]),d)return(0,h.jsx)("div",{children:"Loading..."});if(c)return(0,h.jsxs)("div",{children:["Error: ",c]});if(!t)return(0,h.jsx)("div",{children:"No route data available"});const f=e=>"string"===typeof e?e:e&&"object"===typeof e?"html"===e["@type"]&&e.value?(0,h.jsx)("div",{dangerouslySetInnerHTML:{__html:e.value}}):JSON.stringify(e):"";return(0,h.jsxs)("div",{children:[(0,h.jsx)("h1",{children:f(t.name)}),f(t.description),(0,h.jsx)(j,{}),(0,h.jsx)(x,{route:t,position:s,heading:a,isOffline:p}),(0,h.jsx)(i.N_,{to:"/catalog",children:"\u041d\u0430\u0437\u0430\u0434 \u043a \u043a\u0430\u0442\u0430\u043b\u043e\u0433\u0443"}),p&&(0,h.jsx)("div",{children:"\u0412\u044b \u043d\u0430\u0445\u043e\u0434\u0438\u0442\u0435\u0441\u044c \u0432 \u043e\u0444\u043b\u0430\u0439\u043d-\u0440\u0435\u0436\u0438\u043c\u0435. \u041d\u0435\u043a\u043e\u0442\u043e\u0440\u044b\u0435 \u0444\u0443\u043d\u043a\u0446\u0438\u0438 \u043c\u043e\u0433\u0443\u0442 \u0431\u044b\u0442\u044c \u043d\u0435\u0434\u043e\u0441\u0442\u0443\u043f\u043d\u044b."})]})}},337:(e,t,n)=>{n.d(t,{Fq:()=>a,O5:()=>u,aM:()=>c,dt:()=>d,wp:()=>l});const o="BikeRoutesDB",r="routes",i="catalog";function s(){return new Promise(((e,t)=>{const n=indexedDB.open(o,8);n.onerror=e=>{console.error("Database error: "+e.target.error),t("Error opening DB: "+e.target.error)},n.onsuccess=t=>{e(t.target.result)},n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains(r)){t.createObjectStore(r,{keyPath:"id"}).createIndex("version","version",{unique:!1})}t.objectStoreNames.contains(i)||t.createObjectStore(i,{keyPath:"id"})}}))}function a(e){return new Promise(((t,n)=>{s().then((o=>{const i=o.transaction(r,"readwrite").objectStore(r).put(e);i.onerror=()=>n("Error saving route"),i.onsuccess=()=>t()})).catch(n)}))}function c(e){return new Promise(((t,n)=>{s().then((o=>{const i=o.transaction(r,"readonly").objectStore(r).get(e);i.onerror=()=>n("Error getting route"),i.onsuccess=()=>t(i.result)})).catch(n)}))}function l(e){return new Promise(((t,n)=>{s().then((o=>{const i=o.transaction(r,"readonly").objectStore(r).get(e);i.onerror=()=>n("Error getting route version"),i.onsuccess=()=>t(i.result?i.result.version:null)})).catch(n)}))}function d(e){return new Promise(((t,n)=>{s().then((o=>{const r=o.transaction(i,"readwrite").objectStore(i).put({id:"main",data:e});r.onerror=()=>n("Error saving catalog"),r.onsuccess=()=>t()})).catch(n)}))}function u(){return new Promise(((e,t)=>{s().then((n=>{const o=n.transaction(i,"readonly").objectStore(i).get("main");o.onerror=()=>t("Error getting catalog"),o.onsuccess=()=>e(o.result?o.result.data:null)})).catch(t)}))}}}]);
//# sourceMappingURL=237.fd818b26.chunk.js.map